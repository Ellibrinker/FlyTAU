<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Flight | FLYTAU</title>
  <link href='https://cdn.boxicons.com/3.0.6/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/admin_add_flight.css">
</head>
<body>

  <header class="top-bar">
    <a href="/" class="logo-link">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="company-logo">
    </a>
    <a href="/admin/flights" class="back-home">
      <i class='bx bx-arrow-left'></i>
      Back to flights
    </a>
  </header>

  <div class="wrapper">

    {% if error %}
      <div class="error-box">{{ error }}</div>
    {% endif %}

    {% if step == 1 %}
      <div class="box">
        <h3 class="section-title">Step 1: Choose route & departure</h3>
        <p class="muted">We’ll check flight duration, and show only available planes & crew</p>

        <form method="POST">
          <input type="hidden" name="step" value="1" />
          <div class="row">
            <div class="input-box">
              <input name="origin" placeholder="Origin (e.g. TLV)" required />
              <i class='bx bx-plane'></i>
            </div>

            <div class="input-box">
              <input name="destination" placeholder="Destination (e.g. ATH)" required />
              <i class='bx bx-map'></i>
            </div>

            <div class="input-box">
              <input type="date" name="departure_date" required />
            </div>

            <div class="input-box">
              <input type="time" name="departure_time" required />
            </div>
          </div>

          <div class="row" style="margin-top: 12px;">
            <button type="submit">Next</button>
          </div>
        </form>
      </div>

    {% else %}
      <div class="box">
        <h3 class="section-title">Step 2: Select plane, crew & pricing</h3>

        <p class="row" style="flex-wrap: wrap; gap:8px;">
          <span class="pill">Route: <b>{{ data.origin }}</b> → <b>{{ data.destination }}</b></span>
          <span class="pill">Departure: <b>{{ data.departure_date }}</b> <b>{{ data.departure_time }}</b></span>
          <span class="pill">Duration: <b>{{ data.duration_min }}</b> min</span>
          <span class="pill">Type: <b>{% if data.is_long %}Long{% else %}Short{% endif %}</b></span>
        </p>

        <form method="POST" id="createForm">
          <input type="hidden" name="step" value="2" />
          <input type="hidden" name="origin" value="{{ data.origin }}" />
          <input type="hidden" name="destination" value="{{ data.destination }}" />
          <input type="hidden" name="departure_date" value="{{ data.departure_date }}" />
          <input type="hidden" name="departure_time" value="{{ data.departure_time }}" />

          <div class="box">
            <h3 class="section-title">Select plane</h3>

            {% if not data.planes or data.planes|length == 0 %}
              <div class="error-box">No available planes for this time window.</div>
              <p class="muted">Try another departure time/date, or a different route.</p>
            {% else %}
              <select name="plane_id" id="planeSelect" required data-selected="{{ data.selected_plane_id or '' }}">
                <option value="" disabled {% if not data.selected_plane_id %}selected{% endif %}>Select a plane…</option>
                {% for p in data.planes %}
  <option
    value="{{ p.plane_id }}"
    {% if data.selected_plane_id == p.plane_id %}selected{% endif %}
    data-big="{{ 1 if p.is_big else 0 }}"
  >
    Plane {{ p.plane_id }} ({{ p.manufacturer }}) ({{ 'big' if p.is_big else 'small' }})
  </option>
{% endfor %}

              </select>

              <input type="hidden" id="isBigSelected" value="{% if data.is_big_selected is not none %}{{ 1 if data.is_big_selected else 0 }}{% else %}{% endif %}">
            {% endif %}
          </div>

          <div class="two-col">
            <div class="box">
              <h3 class="section-title">
                Select pilots
                <span class="pill">Need: <span class="count" id="pilotsNeed">{{ data.pilots_needed }}</span></span>
                <span class="pill">Selected: <span class="count" id="pilotsSelected">{{ data.selected_pilot_ids|length if data.selected_pilot_ids else 0 }}</span>/<span class="count" id="pilotsNeed2">{{ data.pilots_needed }}</span></span>
              </h3>

              {% if not data.pilots %}
                <div class="error-box">No available pilots for this time window.</div>
                <p class="muted">Try another time/date or route.</p>
              {% else %}
                <p class="hint" id="pilotsHint">You can select exactly {{ data.pilots_needed }} pilots.</p>
                {% for pl in data.pilots %}
                  <label>
                    <input type="checkbox" class="pilot-checkbox" name="pilot_ids" value="{{ pl.id }}"
                      {% if data.selected_pilot_ids and (pl.id|string) in data.selected_pilot_ids %}checked{% endif %}>
                    {{ pl.id }} — {{ pl.first_name }} {{ pl.last_name }}
                  </label>
                {% endfor %}
              {% endif %}
            </div>

            <div class="box">
              <h3 class="section-title">
                Select attendants
                <span class="pill">Need: <span class="count" id="faNeed">{{ data.fa_needed }}</span></span>
                <span class="pill">Selected: <span class="count" id="faSelected">{{ data.selected_fa_ids|length if data.selected_fa_ids else 0 }}</span>/<span class="count" id="faNeed2">{{ data.fa_needed }}</span></span>
              </h3>

              {% if not data.attendants %}
                <div class="error-box">No available attendants for this time window.</div>
                <p class="muted">Try another time/date or route.</p>
              {% else %}
                <p class="hint" id="faHint">You can select exactly {{ data.fa_needed }} attendants.</p>
                {% for fa in data.attendants %}
                  <label>
                    <input type="checkbox" class="fa-checkbox" name="fa_ids" value="{{ fa.id }}"
                      {% if data.selected_fa_ids and (fa.id|string) in data.selected_fa_ids %}checked{% endif %}>
                    {{ fa.id }} — {{ fa.first_name }} {{ fa.last_name }}
                  </label>
                {% endfor %}
              {% endif %}
            </div>
          </div>

          <div class="box">
            <h3 class="section-title">Pricing</h3>

            <div class="input-box">
              <input type="number" step="0.01" name="regular_price" placeholder="Regular price"
                    value="{{ data.regular_price if data.regular_price is not none else '' }}" required />
              <i class='bx bx-cash'></i>
            </div>

            <div class="input-box" id="businessPriceBox" style="display:none;">
              <input type="number" step="0.01" name="business_price" id="businessPriceInput"
                    placeholder="Business price"
                    value="{{ data.business_price if data.business_price is not none else '' }}" />
              <i class='bx bx-briefcase-alt-2'></i>
            </div>

            <p class="muted" id="businessNote" style="display:none;">
              Note: Business price is required for Big planes (Business class).
            </p>
          </div>

          <div class="box">
            <p id="validationMsg" class="muted"></p>
            <button type="submit" id="submitBtn">Create Flight</button>
          </div>
        </form>
      </div>

<script>
  (function () {
    const NEEDS = {
      big: { pilots: 3, fa: 6 },
      small: { pilots: 2, fa: 3 }
    };

    const pilotsNeedEl = document.getElementById("pilotsNeed");
    const pilotsNeed2El = document.getElementById("pilotsNeed2");
    const faNeedEl = document.getElementById("faNeed");
    const faNeed2El = document.getElementById("faNeed2");

    const pilotBoxes = Array.from(document.querySelectorAll(".pilot-checkbox"));
    const faBoxes = Array.from(document.querySelectorAll(".fa-checkbox"));

    const pilotsSelectedEl = document.getElementById("pilotsSelected");
    const faSelectedEl = document.getElementById("faSelected");

    const msgEl = document.getElementById("validationMsg");
    const submitBtn = document.getElementById("submitBtn");
    const planeSelect = document.getElementById("planeSelect");

    const businessBox = document.getElementById("businessPriceBox");
    const businessInput = document.getElementById("businessPriceInput");
    const businessNote = document.getElementById("businessNote");

    const isBigSelectedHidden = document.getElementById("isBigSelected");
    const isLong = {{ 1 if data.is_long else 0 }};

    function setNeeds(isBig) {
      const need = isBig ? NEEDS.big : NEEDS.small;

      if (pilotsNeedEl) pilotsNeedEl.textContent = String(need.pilots);
      if (pilotsNeed2El) pilotsNeed2El.textContent = String(need.pilots);
      if (faNeedEl) faNeedEl.textContent = String(need.fa);
      if (faNeed2El) faNeed2El.textContent = String(need.fa);

      if (businessBox && businessInput && businessNote) {
        if (isBig) {
          businessBox.style.display = "";
          businessNote.style.display = "";
          businessInput.required = true;
        } else {
          businessBox.style.display = "none";
          businessNote.style.display = "none";
          businessInput.required = false;
          businessInput.value = "";
        }
      }

      return need;
    }

    function getIsBigFromPage() {
      // 1) If user selected a plane -> always trust the selected option's data-big
      if (planeSelect && planeSelect.value) {
        const opt = planeSelect.options[planeSelect.selectedIndex];
        return opt && opt.dataset && opt.dataset.big === "1";
      }

      // 2) If long flight -> must be big (no plane picked yet)
      if (isLong) return true;

      // 3) Fallback: server-provided hidden (after failed POST)
      if (isBigSelectedHidden && isBigSelectedHidden.value !== "") {
        return isBigSelectedHidden.value === "1";
      }

      // 4) Default
      return false;
    }

    function updateGroupLimit(boxes, need, selectedEl) {
      const selected = boxes.filter(b => b.checked).length;
      if (selectedEl) selectedEl.textContent = String(selected);
      boxes.forEach(b => { if (!b.checked) b.disabled = (selected >= need); });
      return selected;
    }

    function validateAll() {
      const isBig = getIsBigFromPage();
      const need = setNeeds(isBig);

      const pilotsSelected = updateGroupLimit(pilotBoxes, need.pilots, pilotsSelectedEl);
      const faSelected = updateGroupLimit(faBoxes, need.fa, faSelectedEl);

      const planeOk = planeSelect ? !!planeSelect.value : true;
      const pilotsOk = (pilotBoxes.length === 0) ? true : (pilotsSelected === need.pilots);
      const faOk = (faBoxes.length === 0) ? true : (faSelected === need.fa);

      let businessOk = true;
      if (isBig && businessInput) {
        businessOk = !!businessInput.value && parseFloat(businessInput.value) > 0;
      }

      let longOk = true;
      if (isLong && !isBig) longOk = false;

      let msg = "";
      if (!planeOk) msg = "Please select a plane.";
      else if (!longOk) msg = "Long flights (> 360 minutes) must use a Big plane.";
      else if (!pilotsOk) msg = `Please select exactly ${need.pilots} pilots.`;
      else if (!faOk) msg = `Please select exactly ${need.fa} attendants.`;
      else if (!businessOk) msg = "Please enter a valid Business price (Big planes only).";
      else msg = "All set ✅ You can create the flight.";

      if (msgEl) msgEl.textContent = msg;
      if (submitBtn) submitBtn.disabled = !(planeOk && longOk && pilotsOk && faOk && businessOk);
    }

    pilotBoxes.forEach(b => b.addEventListener("change", validateAll));
    faBoxes.forEach(b => b.addEventListener("change", validateAll));
    if (planeSelect) planeSelect.addEventListener("change", validateAll);
    if (businessInput) businessInput.addEventListener("input", validateAll);

    validateAll();
  })();
</script>


    {% endif %}
  </div>
</body>
</html>
