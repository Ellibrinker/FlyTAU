<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Seats</title>
  <link rel="stylesheet" href="/static/select_seats.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet"/>
</head>

<body>
  <header class="top-bar">
    <a href="/" class="logo-link">
      <img src="/static/logo.png" alt="Company Logo" class="company-logo">
    </a>
  </header>

  <div class="card">
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    {% if flight %}
      <h1 class="title">Select Seats</h1>
      <p class="sub">
        Flight {{ flight.flight_id }} — {{ flight.origin_airport }} → {{ flight.destination_airport }}
        | {{ flight.departure_date }} {{ flight.departure_time }}
      </p>

      <form method="POST" action="/select_seats">
        <input type="hidden" name="flight_id" value="{{ flight.flight_id }}">

        <div class="row">
          <div class="small">Selected seats: <span id="count">0</span></div>
        </div>

      {% if not session.get('user_email') %}
      <div id="personalModal" class="modal">
        <div class="modal-content">
          <h2>Personal Details</h2>

          <form id="personalForm">
            <div class="modal-row">
              <label>Full Name</label>
              <input type="text" name="guest_full_name" required>
            </div>

            <div class="modal-row">
              <label>Email</label>
              <input type="email" name="guest_email" required>
            </div>

            <div class="modal-row">
              <label>Passport Number</label>
              <input type="text" name="guest_passport" required>
            </div>

            <div class="modal-row">
              <label>Birth Date</label>
              <input type="date" name="guest_birthdate" required>
            </div>

            <div class="modal-row phone-row">
              <label>Phone Number</label>
              <input type="tel" name="guest_phone[]" required>
              <button type="button" class="add-phone">+ Add phone</button>
            </div>

            <div id="extraPhones"></div>

            <button type="submit" class="btn">Continue</button>
          </form>
        </div>
      </div>
      {% endif %}



        <!-- Regular -->
        {% if seats_by_class.get('Regular') %}
          <h3 style="margin-top:16px;">
            Regular
            {% if flight.regular_price %}(₪{{ "%.2f"|format(flight.regular_price) }}){% endif %}
          </h3>

          {% set cols = grid_by_class['Regular'].cols if grid_by_class.get('Regular') else 6 %}
          <div class="grid" style="grid-template-columns: repeat({{ cols }}, 54px);">
            {% for s in seats_by_class['Regular'] %}
              {% set st = s.status|lower %}
              <div class="seat {% if st=='available' %}available{% else %}booked{% endif %}"
                   data-status="{{ st }}"
                   data-id="{{ s.flight_seat_id }}"
                   title="Row {{ s.row_num }} Col {{ s.column_number }}">
                {{ s.row_num }}{{ s.column_number }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Business -->
        {% if seats_by_class.get('Business') and flight.business_price %}
          <h3 style="margin-top:18px;">
            Business (₪{{ "%.2f"|format(flight.business_price) }})
          </h3>

          {% set cols = grid_by_class['Business'].cols if grid_by_class.get('Business') else 6 %}
          <div class="grid" style="grid-template-columns: repeat({{ cols }}, 54px);">
            {% for s in seats_by_class['Business'] %}
              {% set st = s.status|lower %}
              <div class="seat {% if st=='available' %}available{% else %}booked{% endif %}"
                   data-status="{{ st }}"
                   data-id="{{ s.flight_seat_id }}"
                   title="Row {{ s.row_num }} Col {{ s.column_number }}">
                {{ s.row_num }}{{ s.column_number }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- hidden inputs will be added via JS -->
        <div id="hiddenInputs"></div>

        <div class="row">
          <a class="btn secondary" href="/search_flights">Back</a>
          <button class="btn" type="submit">Confirm booking</button>
        </div>
      </form>

    {% else %}
      <div class="error">Flight not found.</div>
      <a class="btn secondary" href="/search_flights">Back</a>
    {% endif %}
  </div>

  <script>
    const selected = new Set();
    const hidden = document.getElementById("hiddenInputs");
    const count = document.getElementById("count");

    function syncHiddenInputs() {
      hidden.innerHTML = "";
      Array.from(selected).forEach(id => {
        const inp = document.createElement("input");
        inp.type = "hidden";
        inp.name = "flight_seat_id";
        inp.value = id;
        hidden.appendChild(inp);
      });
      count.innerText = selected.size;
    }

    document.querySelectorAll(".seat").forEach(el => {
      el.addEventListener("click", () => {
        if (el.dataset.status !== "available") return;

        const id = el.dataset.id;
        if (selected.has(id)) {
          selected.delete(id);
          el.classList.remove("selected");
        } else {
          selected.add(id);
          el.classList.add("selected");
        }
        syncHiddenInputs();
      });
    });

      const modal = document.getElementById("personalModal");
      const closeBtn = document.querySelector(".close-btn");
      const personalForm = document.getElementById("personalForm");
      const extraPhones = document.getElementById("extraPhones");
      const addPhoneBtn = document.querySelector(".add-phone");

      // Open modal automatically for unregistered users
      {% if not session.get('user_email') %}
        modal.style.display = "flex";
      {% endif %}

      window.onclick = (e) => {
        if (e.target === modal) {
          return;
        }
      };

      // Add phone button
      addPhoneBtn.addEventListener("click", () => {
        const div = document.createElement("div");
        div.className = "modal-row";
        div.innerHTML = `
          <label>Additional Phone</label>
          <input type="tel" name="guest_phone[]" required>
        `;
        extraPhones.appendChild(div);
      });

      personalForm.addEventListener("submit", (e) => {
        e.preventDefault();

        if (!personalForm.checkValidity()) {
          alert("Please fill all details.");
          return;
        }

        const mainForm = document.querySelector("form[action='/select_seats']");
        const formData = new FormData(personalForm);

        for (let [name, value] of formData.entries()) {
          const inp = document.createElement("input");
          inp.type = "hidden";
          inp.name = name;
          inp.value = value;
          mainForm.appendChild(inp);
        }

        modal.style.display = "none";
      });
  </script>

</body>
</html>
